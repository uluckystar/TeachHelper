<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²é€‰æ‹©ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-title {
            color: #333;
            border-bottom: 2px solid #409eff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-case {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .test-case h4 {
            margin: 0 0 10px 0;
            color: #606266;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #f0f9ff;
            border: 1px solid #67c23a;
            color: #67c23a;
        }
        .error {
            background-color: #fef0f0;
            border: 1px solid #f56c6c;
            color: #f56c6c;
        }
        button {
            background-color: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background-color: #66b1ff;
        }
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            margin: 10px 0;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            margin: 5px 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h2 class="test-title">æ³¨å†ŒåŠŸèƒ½è§’è‰²é€‰æ‹©ä¿®å¤æµ‹è¯•</h2>
        
        <div class="test-case">
            <h4>æµ‹è¯•åœºæ™¯ï¼šæ¨¡æ‹Ÿæ³¨å†Œè¡¨å•è§’è‰²é€‰æ‹©</h4>
            <p>è¿™ä¸ªæµ‹è¯•æ¨¡æ‹Ÿäº†ä¿®å¤åçš„æ³¨å†Œè¡¨å•è¡Œä¸ºï¼ŒéªŒè¯è§’è‰²é€‰æ‹©åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
            
            <form id="registerForm">
                <label>ç”¨æˆ·å:</label>
                <input type="text" id="username" placeholder="è¾“å…¥ç”¨æˆ·åï¼Œå¦‚ï¼šç‹å¹³" value="ç‹å¹³">
                
                <label>é‚®ç®±:</label>
                <input type="email" id="email" placeholder="è¾“å…¥é‚®ç®±" value="wangping@example.com">
                
                <label>å¯†ç :</label>
                <input type="password" id="password" placeholder="è¾“å…¥å¯†ç " value="test123456">
                
                <label>è§’è‰²:</label>
                <select id="roles" multiple>
                    <option value="">è¯·é€‰æ‹©è§’è‰²</option>
                    <option value="STUDENT">å­¦ç”Ÿ</option>
                    <option value="TEACHER">æ•™å¸ˆ</option>
                </select>
                
                <button type="button" onclick="testRegistration()">æµ‹è¯•æ³¨å†ŒéªŒè¯</button>
            </form>
            
            <div id="result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-case">
            <h4>è§’è‰²éªŒè¯å‡½æ•°æµ‹è¯•</h4>
            <button onclick="testRoleValidation()">è¿è¡Œè§’è‰²éªŒè¯æµ‹è¯•</button>
            <div id="roleTestResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-case">
            <h4>ç”¨æˆ·åéªŒè¯æµ‹è¯•ï¼ˆä¸­æ–‡æ”¯æŒï¼‰</h4>
            <button onclick="testUsernameValidation()">è¿è¡Œç”¨æˆ·åéªŒè¯æµ‹è¯•</button>
            <div id="usernameTestResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿ registerSecurity.ts ä¸­çš„éªŒè¯å‡½æ•°
        const REGISTER_CONFIG = {
            ALLOWED_ROLES: ['STUDENT', 'TEACHER'],
            USERNAME_RULES: {
                reservedWords: ['admin', 'root', 'system', 'administrator', 'teacher', 'student', 'ç®¡ç†å‘˜', 'æ•™å¸ˆ', 'å­¦ç”Ÿ', 'ç³»ç»Ÿ']
            }
        }

        const validateRegistration = {
            username: (username) => {
                if (!username) {
                    return 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º'
                }
                
                // æ£€æŸ¥å­—ç¬¦æ˜¯å¦åˆæ³•ï¼ˆä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰
                const validCharPattern = /^[\u4e00-\u9fff\u3400-\u4dbfa-zA-Z0-9_]+$/
                if (!validCharPattern.test(username)) {
                    return 'ç”¨æˆ·ååªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—å’Œä¸‹åˆ’çº¿'
                }
                
                // æ£€æŸ¥é•¿åº¦ï¼šä¸­æ–‡å­—ç¬¦2-50ä¸ªï¼Œè‹±æ–‡å­—ç¬¦3-50ä¸ª
                const chineseCharCount = (username.match(/[\u4e00-\u9fff\u3400-\u4dbf]/g) || []).length
                const totalLength = username.length
                
                if (totalLength > 50) {
                    return 'ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦'
                }
                
                // å¦‚æœåŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œæœ€å°‘2ä¸ªå­—ç¬¦
                if (chineseCharCount > 0) {
                    if (totalLength < 2) {
                        return 'åŒ…å«ä¸­æ–‡çš„ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦'
                    }
                } else {
                    // çº¯è‹±æ–‡æ•°å­—ç»„åˆï¼Œæœ€å°‘3ä¸ªå­—ç¬¦
                    if (totalLength < 3) {
                        return 'è‹±æ–‡ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦'
                    }
                }
                
                // æ£€æŸ¥ä¿ç•™è¯
                const lowerUsername = username.toLowerCase()
                for (const reserved of REGISTER_CONFIG.USERNAME_RULES.reservedWords) {
                    if (lowerUsername === reserved.toLowerCase() || username === reserved) {
                        return 'ç”¨æˆ·åä¸èƒ½ä½¿ç”¨ä¿ç•™è¯'
                    }
                }
                
                return null
            },
            
            roles: (roles) => {
                if (!roles || roles.length === 0) {
                    return 'è¯·é€‰æ‹©è§’è‰²'
                }
                
                if (roles.length > 1) {
                    return 'ä¸€ä¸ªç”¨æˆ·åªèƒ½æœ‰ä¸€ä¸ªè§’è‰²'
                }
                
                const role = roles[0]
                if (!REGISTER_CONFIG.ALLOWED_ROLES.includes(role)) {
                    return 'åªå…è®¸æ³¨å†Œå­¦ç”Ÿæˆ–æ•™å¸ˆè§’è‰²'
                }
                
                return null
            },
            
            email: (email) => {
                if (!email) {
                    return 'é‚®ç®±ä¸èƒ½ä¸ºç©º'
                }
                
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
                if (!emailPattern.test(email)) {
                    return 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®'
                }
                
                return null
            }
        }

        function testRegistration() {
            const username = document.getElementById('username').value
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            const rolesSelect = document.getElementById('roles')
            const selectedOptions = Array.from(rolesSelect.selectedOptions).map(option => option.value).filter(v => v)
            
            const resultDiv = document.getElementById('result')
            resultDiv.style.display = 'block'
            
            // éªŒè¯å„ä¸ªå­—æ®µ
            const usernameError = validateRegistration.username(username)
            const emailError = validateRegistration.email(email)
            const rolesError = validateRegistration.roles(selectedOptions)
            
            let html = '<h4>éªŒè¯ç»“æœï¼š</h4>'
            html += `<p><strong>ç”¨æˆ·å "${username}":</strong> ${usernameError || 'âœ… é€šè¿‡'}</p>`
            html += `<p><strong>é‚®ç®± "${email}":</strong> ${emailError || 'âœ… é€šè¿‡'}</p>`
            html += `<p><strong>è§’è‰²é€‰æ‹©:</strong> ${rolesError || `âœ… é€šè¿‡ï¼Œé€‰æ‹©äº†è§’è‰²: ${selectedOptions.join(', ')}`}</p>`
            
            if (!usernameError && !emailError && !rolesError) {
                resultDiv.className = 'result success'
                html += '<p><strong>ğŸ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼å¯ä»¥æäº¤æ³¨å†Œ</strong></p>'
            } else {
                resultDiv.className = 'result error'
                html += '<p><strong>âŒ å­˜åœ¨éªŒè¯é”™è¯¯ï¼Œè¯·ä¿®æ­£åé‡è¯•</strong></p>'
            }
            
            resultDiv.innerHTML = html
        }

        function testRoleValidation() {
            const resultDiv = document.getElementById('roleTestResult')
            resultDiv.style.display = 'block'
            
            const testCases = [
                { roles: [], expected: 'è¯·é€‰æ‹©è§’è‰²' },
                { roles: ['STUDENT'], expected: null },
                { roles: ['TEACHER'], expected: null },
                { roles: ['ADMIN'], expected: 'åªå…è®¸æ³¨å†Œå­¦ç”Ÿæˆ–æ•™å¸ˆè§’è‰²' },
                { roles: ['STUDENT', 'TEACHER'], expected: 'ä¸€ä¸ªç”¨æˆ·åªèƒ½æœ‰ä¸€ä¸ªè§’è‰²' },
                { roles: ['INVALID'], expected: 'åªå…è®¸æ³¨å†Œå­¦ç”Ÿæˆ–æ•™å¸ˆè§’è‰²' }
            ]
            
            let html = '<h4>è§’è‰²éªŒè¯æµ‹è¯•ç»“æœï¼š</h4>'
            let allPassed = true
            
            testCases.forEach((testCase, index) => {
                const result = validateRegistration.roles(testCase.roles)
                const passed = result === testCase.expected
                allPassed = allPassed && passed
                
                html += `<p><strong>æµ‹è¯• ${index + 1}:</strong> `
                html += `è§’è‰² [${testCase.roles.join(', ')}] `
                html += `${passed ? 'âœ…' : 'âŒ'} `
                html += `(æœŸæœ›: ${testCase.expected || 'é€šè¿‡'}, å®é™…: ${result || 'é€šè¿‡'})</p>`
            })
            
            resultDiv.className = allPassed ? 'result success' : 'result error'
            resultDiv.innerHTML = html
        }

        function testUsernameValidation() {
            const resultDiv = document.getElementById('usernameTestResult')
            resultDiv.style.display = 'block'
            
            const testCases = [
                { username: 'ç‹å¹³', expected: null, description: '2ä¸ªä¸­æ–‡å­—ç¬¦' },
                { username: 'å¼ ä¸‰ä¸°', expected: null, description: '3ä¸ªä¸­æ–‡å­—ç¬¦' },
                { username: 'æ', expected: 'åŒ…å«ä¸­æ–‡çš„ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦', description: '1ä¸ªä¸­æ–‡å­—ç¬¦ï¼ˆä¸å¤Ÿï¼‰' },
                { username: 'ab', expected: 'è‹±æ–‡ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦', description: '2ä¸ªè‹±æ–‡å­—ç¬¦ï¼ˆä¸å¤Ÿï¼‰' },
                { username: 'abc', expected: null, description: '3ä¸ªè‹±æ–‡å­—ç¬¦' },
                { username: 'user123', expected: null, description: 'è‹±æ–‡+æ•°å­—' },
                { username: 'ç‹å¹³123', expected: null, description: 'ä¸­æ–‡+æ•°å­—' },
                { username: 'user@name', expected: 'ç”¨æˆ·ååªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—å’Œä¸‹åˆ’çº¿', description: 'åŒ…å«ç‰¹æ®Šå­—ç¬¦' },
                { username: 'admin', expected: 'ç”¨æˆ·åä¸èƒ½ä½¿ç”¨ä¿ç•™è¯', description: 'ä¿ç•™è¯' },
                { username: 'ç®¡ç†å‘˜', expected: 'ç”¨æˆ·åä¸èƒ½ä½¿ç”¨ä¿ç•™è¯', description: 'ä¸­æ–‡ä¿ç•™è¯' }
            ]
            
            let html = '<h4>ç”¨æˆ·åéªŒè¯æµ‹è¯•ç»“æœï¼š</h4>'
            let allPassed = true
            
            testCases.forEach((testCase, index) => {
                const result = validateRegistration.username(testCase.username)
                const passed = result === testCase.expected
                allPassed = allPassed && passed
                
                html += `<p><strong>æµ‹è¯• ${index + 1}:</strong> `
                html += `"${testCase.username}" (${testCase.description}) `
                html += `${passed ? 'âœ…' : 'âŒ'} `
                if (!passed) {
                    html += `<br>&nbsp;&nbsp;&nbsp;&nbsp;æœŸæœ›: ${testCase.expected || 'é€šè¿‡'}<br>&nbsp;&nbsp;&nbsp;&nbsp;å®é™…: ${result || 'é€šè¿‡'}`
                }
                html += `</p>`
            })
            
            resultDiv.className = allPassed ? 'result success' : 'result error'
            resultDiv.innerHTML = html
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è®¾ç½®é»˜è®¤é€‰æ‹©çš„è§’è‰²
        window.addEventListener('load', function() {
            const rolesSelect = document.getElementById('roles')
            rolesSelect.value = 'STUDENT'
        })
    </script>
</body>
</html>
