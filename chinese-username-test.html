<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中文用户名支持测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-case {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
        }
        .test-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .test-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .expected { font-style: italic; color: #6c757d; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>中文用户名支持测试</h1>
    
    <div class="test-container">
        <h3>前端验证测试</h3>
        <p>测试前端JavaScript验证逻辑对中文用户名的支持</p>
        
        <div class="test-case">
            <div class="test-title">✅ 有效的中文用户名</div>
            <div class="test-input">
                <input type="text" id="valid1" value="张三" placeholder="输入用户名">
                <button onclick="testFrontendValidation('valid1')">验证</button>
            </div>
            <div class="expected">预期：通过验证</div>
            <div id="result-valid1" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">✅ 中英文混合用户名</div>
            <div class="test-input">
                <input type="text" id="valid2" value="张三ABC123" placeholder="输入用户名">
                <button onclick="testFrontendValidation('valid2')">验证</button>
            </div>
            <div class="expected">预期：通过验证</div>
            <div id="result-valid2" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">✅ 带下划线的中文用户名</div>
            <div class="test-input">
                <input type="text" id="valid3" value="李四_测试" placeholder="输入用户名">
                <button onclick="testFrontendValidation('valid3')">验证</button>
            </div>
            <div class="expected">预期：通过验证</div>
            <div id="result-valid3" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">❌ 包含特殊字符的用户名</div>
            <div class="test-input">
                <input type="text" id="invalid1" value="张三@测试" placeholder="输入用户名">
                <button onclick="testFrontendValidation('invalid1')">验证</button>
            </div>
            <div class="expected">预期：验证失败</div>
            <div id="result-invalid1" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">❌ 中文保留词</div>
            <div class="test-input">
                <input type="text" id="invalid2" value="管理员" placeholder="输入用户名">
                <button onclick="testFrontendValidation('invalid2')">验证</button>
            </div>
            <div class="expected">预期：验证失败</div>
            <div id="result-invalid2" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">❌ 用户名过短</div>
            <div class="test-input">
                <input type="text" id="invalid3" value="李" placeholder="输入用户名">
                <button onclick="testFrontendValidation('invalid3')">验证</button>
            </div>
            <div class="expected">预期：验证失败</div>
            <div id="result-invalid3" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="test-container">
        <h3>后端API测试</h3>
        <p>测试后端验证器对中文用户名的支持</p>
        
        <div class="test-case">
            <div class="test-title">完整注册测试 - 中文用户名</div>
            <div style="display: grid; gap: 10px;">
                <input type="text" id="api-username" value="测试用户001" placeholder="用户名">
                <input type="email" id="api-email" value="testuser001@example.com" placeholder="邮箱">
                <input type="password" id="api-password" value="Test123456" placeholder="密码">
                <select id="api-role">
                    <option value="STUDENT">学生</option>
                    <option value="TEACHER">教师</option>
                </select>
                <button onclick="testBackendAPI()">测试后端注册</button>
            </div>
            <div id="api-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // 前端验证逻辑 (模拟 registerSecurity.ts 的逻辑)
        const USERNAME_PATTERN = /^[\u4e00-\u9fa5a-zA-Z0-9_]{3,50}$/;
        const RESERVED_WORDS = ['admin', 'root', 'system', 'administrator', 'teacher', 'student', '管理员', '教师', '学生', '系统'];

        function validateUsername(username) {
            if (!username) {
                return '用户名不能为空';
            }
            
            if (!USERNAME_PATTERN.test(username)) {
                return '用户名只能包含中文、英文、数字和下划线，长度3-50个字符';
            }
            
            if (RESERVED_WORDS.includes(username.toLowerCase())) {
                return '用户名不能使用保留词';
            }
            
            return null;
        }

        function testFrontendValidation(inputId) {
            const input = document.getElementById(inputId);
            const username = input.value;
            const resultId = 'result-' + inputId;
            const resultElement = document.getElementById(resultId);
            
            const error = validateUsername(username);
            
            if (error) {
                resultElement.textContent = `❌ ${error}`;
                resultElement.className = 'result error';
            } else {
                resultElement.textContent = `✅ 验证通过`;
                resultElement.className = 'result success';
            }
            
            resultElement.style.display = 'block';
        }

        async function testBackendAPI() {
            const username = document.getElementById('api-username').value;
            const email = document.getElementById('api-email').value;
            const password = document.getElementById('api-password').value;
            const role = document.getElementById('api-role').value;
            
            const data = {
                username: username,
                email: email,
                password: password,
                roles: [role]
            };

            try {
                const response = await fetch('http://localhost:8080/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.text();
                const resultElement = document.getElementById('api-result');
                
                if (response.ok) {
                    resultElement.textContent = `✅ 注册成功: ${result}`;
                    resultElement.className = 'result success';
                } else {
                    resultElement.textContent = `❌ 注册失败 (${response.status}): ${result}`;
                    resultElement.className = 'result error';
                }
                
                resultElement.style.display = 'block';
            } catch (error) {
                const resultElement = document.getElementById('api-result');
                resultElement.textContent = `❌ 网络错误: ${error.message}`;
                resultElement.className = 'result error';
                resultElement.style.display = 'block';
            }
        }

        // 页面加载时自动运行所有前端验证测试
        window.addEventListener('load', () => {
            console.log('页面加载完成，可以开始测试中文用户名支持');
            
            // 自动测试所有预设的用户名
            setTimeout(() => {
                ['valid1', 'valid2', 'valid3', 'invalid1', 'invalid2', 'invalid3'].forEach(id => {
                    testFrontendValidation(id);
                });
            }, 500);
        });
    </script>
</body>
</html>
