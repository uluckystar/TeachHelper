# 学生考试权限控制重新设计完成报告

## 需求澄清
经过沟通确认，学生用户的权限范围应该是：
- ✅ 可以查看考试列表
- ✅ 可以参加考试（获取基本考试信息）
- ✅ 可以在参加考试时获取题目（但不包含答案和评分标准）
- ❌ 不能查看题目详情页面（管理界面）
- ❌ 不能查看考试统计信息
- ❌ 不能进行任何题目管理操作

## 权限控制重新设计

### 1. Spring Security配置更新

**文件**: `/backend/src/main/java/com/teachhelper/config/SecurityConfig.java`

```java
// Teacher and Admin can manage exams and questions, Students can view exams for taking
.requestMatchers("/api/exams", "/api/exams/").hasAnyRole("TEACHER", "ADMIN", "STUDENT") // 学生可以查看考试列表
.requestMatchers("/api/exams/*/take").hasAnyRole("TEACHER", "ADMIN", "STUDENT") // 学生可以参加考试（如果需要专门的API）
.requestMatchers("/api/exams/*/statistics").hasAnyRole("TEACHER", "ADMIN") // 统计信息仅限教师和管理员
.requestMatchers("/api/exams/*/classrooms").hasAnyRole("TEACHER", "ADMIN") // 班级管理仅限教师和管理员
.requestMatchers("/api/exams/*/publish").hasAnyRole("TEACHER", "ADMIN") // 发布考试仅限教师和管理员
.requestMatchers("/api/exams/*/unpublish").hasAnyRole("TEACHER", "ADMIN") // 撤销发布仅限教师和管理员
.requestMatchers("/api/exams/*/end").hasAnyRole("TEACHER", "ADMIN") // 结束考试仅限教师和管理员
.requestMatchers("/api/exams/*").hasAnyRole("TEACHER", "ADMIN", "STUDENT") // 学生可以查看考试基本信息（用于参加考试）
.requestMatchers("/api/exams/**").hasAnyRole("TEACHER", "ADMIN") // 其他考试管理功能仅限教师和管理员
.requestMatchers("/api/questions/exam/*/take").hasAnyRole("TEACHER", "ADMIN", "STUDENT") // 学生可以在参加考试时获取题目
.requestMatchers("/api/questions/**").hasAnyRole("TEACHER", "ADMIN") // 其他题目管理功能仅限教师和管理员
```

### 2. API端点分离

#### 题目管理端点（教师/管理员）
- `GET /api/questions/exam/{examId}` - 获取考试的所有题目（包含答案和评分标准）
- 权限：`@PreAuthorize("hasRole('ADMIN') or hasRole('TEACHER')")`

#### 学生考试端点
- `GET /api/questions/exam/{examId}/take` - 学生参加考试时获取题目（不包含答案）
- 权限：`@PreAuthorize("hasRole('ADMIN') or hasRole('TEACHER') or hasRole('STUDENT')")`

### 3. 数据响应分离

**QuestionController中新增方法**:
```java
/**
 * 转换题目为学生参加考试时的响应，不包含参考答案和评分标准
 */
private QuestionResponse convertToResponseForTaking(Question question) {
    QuestionResponse response = new QuestionResponse();
    response.setId(question.getId());
    response.setTitle(question.getTitle());
    response.setContent(question.getContent());
    response.setQuestionType(question.getQuestionType());
    response.setMaxScore(question.getMaxScore().doubleValue());
    // 不设置参考答案
    response.setCreatedAt(question.getCreatedAt());
    response.setUpdatedAt(question.getUpdatedAt());
    
    // 转换选择题选项，但不包含正确答案信息
    if (question.getOptions() != null && !question.getOptions().isEmpty()) {
        List<QuestionOptionDTO> optionDTOs = question.getOptions().stream()
            .map(option -> {
                QuestionOptionDTO dto = new QuestionOptionDTO();
                dto.setId(option.getId());
                dto.setContent(option.getContent());
                // 不设置正确答案标识
                dto.setOptionOrder(option.getOptionOrder());
                return dto;
            })
            .collect(Collectors.toList());
        response.setOptions(optionDTOs);
    }
    
    // 不包含评分标准和统计信息
    return response;
}
```

### 4. 前端API调用更新

**文件**: `/frontend/src/api/question.ts`

```typescript
// 学生参加考试时获取题目列表（不包含答案）
async getQuestionsForTaking(examId: number): Promise<QuestionResponse[]> {
  const response = await api.get<QuestionResponse[]>(`/questions/exam/${examId}/take`)
  return response.data
},
```

**文件**: `/frontend/src/views/student/TakeExamView.vue`

```typescript
const [examResponse, questionsResponse] = await Promise.all([
  examApi.getExam(examId),
  questionApi.getQuestionsForTaking(examId) // 使用学生专用的API
])
```

## 权限控制机制

### 1. 多层权限验证
1. **Spring Security层面**：基于URL路径的角色检查
2. **Controller层面**：`@PreAuthorize`注解的方法级权限控制
3. **Service层面**：ExamService.getExamById()的细粒度业务权限检查

### 2. 学生权限检查逻辑
ExamService.getExamById()中的学生权限验证：
- 考试必须是已发布状态（PUBLISHED）
- 学生必须在考试的目标班级中
- 使用JOIN FETCH避免懒加载问题

### 3. 数据安全
- 学生看到的题目响应不包含：
  - 参考答案（referenceAnswer）
  - 选择题的正确答案标识
  - 评分标准（rubricCriteria）
  - 答案统计信息

## 解决的问题

### 1. 权限控制问题
- ✅ 修复了学生无法访问考试详情的403错误
- ✅ 确保学生只能在参加考试时获取题目
- ✅ 防止学生看到答案和评分标准

### 2. API设计问题
- ✅ 分离了管理端和学生端的API
- ✅ 创建了专门的学生考试API端点
- ✅ 实现了数据响应的差异化处理

### 3. 安全性提升
- ✅ 防止数据泄露（答案、评分标准）
- ✅ 精确的权限控制
- ✅ 多层防护机制

## 使用方式

### 教师/管理员
- 使用`/api/questions/exam/{examId}`获取完整的题目信息
- 可以看到答案、评分标准、统计信息

### 学生
- 使用`/api/questions/exam/{examId}/take`参加考试时获取题目
- 只能看到题目内容，无法看到答案和评分标准
- 仅在考试已发布且自己在目标班级时可访问

## 测试建议

### 1. 权限测试
- 学生登录后访问`/api/questions/exam/{examId}`应返回403
- 学生登录后访问`/api/questions/exam/{examId}/take`应成功
- 教师/管理员访问两个端点都应成功

### 2. 数据安全测试
- 验证学生端API返回的数据不包含答案
- 验证选择题选项没有正确答案标识
- 验证没有评分标准信息

### 3. 业务逻辑测试
- 学生访问未发布的考试应返回权限错误
- 学生访问不在其班级的考试应返回权限错误
- 学生访问已发布且在其班级的考试应正常工作

## 总结

通过重新设计权限控制体系，我们实现了：

1. **清晰的角色分离**：学生、教师、管理员有明确的权限边界
2. **安全的数据访问**：学生无法获取不应该看到的敏感信息
3. **灵活的API设计**：不同角色使用不同的API端点
4. **完善的权限验证**：多层防护确保系统安全

修复完成后，学生可以正常参加考试，但无法查看题目管理界面或获取答案信息，确保了考试的公平性和数据安全性。
